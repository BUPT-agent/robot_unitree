<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G1 æœºå™¨äººæŒ‡æŒ¥ä¸­å¿ƒ (Hybrid)</title>
    <style>
        :root {
            --bg-color: #0a0b10;
            --panel-bg: rgba(20, 25, 35, 0.95);
            --border-color: #333;
            --accent-cyan: #00f3ff;
            --accent-green: #0aff00;
            --accent-red: #ff003c;
            --accent-yellow: #ffcc00;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --font-tech: 'Segoe UI', 'Microsoft YaHei', 'Roboto Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            font-family: var(--font-tech);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  --- */
        header {
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            background: rgba(0,0,0,0.95);
            z-index: 100;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            background: #111;
            padding: 6px 16px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            min-width: 140px;
            justify-content: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #444;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 5px #444;
            transition: all 0.3s;
        }
        .status-dot.active { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .status-dot.busy { background: var(--accent-yellow); box-shadow: 0 0 8px var(--accent-yellow); }
        .status-dot.offline { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }

        .settings-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1.2rem;
        }
        .settings-btn:hover { color: #fff; border-color: #fff; }

        /* --- ä¸»å¸ƒå±€ --- */
        .main-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            position: relative;
        }

        .side-panel { width: 300px; display: flex; flex-direction: column; gap: 20px; }
        .center-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 400px; }

        /* --- å¡ç‰‡é€šç”¨ --- */
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .card-full { flex: 1; }

        .card-header {
            padding: 12px 15px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- æ¨¡å¼åˆ‡æ¢ --- */
        .mode-group {
            display: flex;
            background: #000;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .mode-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
        }
        .mode-btn:hover { background: #1a1a1a; color: #fff; }
        .mode-btn.active {
            background: rgba(0, 243, 255, 0.15);
            color: var(--accent-cyan);
            border-bottom: 2px solid var(--accent-cyan);
        }

        /* æ¨¡å¼æŒ‡ç¤ºå™¨ */
        .mode-indicator {
            padding: 10px;
            font-size: 0.8rem;
            text-align: center;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border-color);
            color: #888;
        }
        .mode-indicator.active-auto { color: var(--accent-green); }
        .mode-indicator.active-director { color: var(--accent-cyan); }

        /* --- å†…å®¹åŒºåŸŸ --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            color: var(--text-dim);
            font-weight: bold;
            font-size: 0.9rem;
            transition: 0.2s;
            border-right: 1px solid var(--border-color);
        }
        .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab.active {
            color: var(--accent-cyan);
            background: rgba(0, 243, 255, 0.05);
            border-bottom: 2px solid var(--accent-cyan);
        }

        .tab-content { padding: 20px; display: none; flex: 1; overflow-y: auto; flex-direction: column; }
        .tab-content.show { display: flex; }

        /* --- æ§ä»¶ --- */
        textarea {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            height: 120px;
            font-family: var(--font-tech);
            font-size: 1rem;
            resize: none;
            width: 100%;
            margin-bottom: 15px;
        }
        textarea:focus { outline: 1px solid var(--accent-cyan); border-color: var(--accent-cyan); }

        .btn {
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            font-family: var(--font-tech);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn-cyan { background: var(--accent-cyan); color: #000; }
        .btn-cyan:hover { background: #fff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); }

        .btn-stop {
            background: rgba(255, 0, 60, 0.1);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 1rem;
        }
        .btn-stop:hover { background: var(--accent-red); color: #fff; box-shadow: 0 0 20px rgba(255, 0, 60, 0.4); }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
        }
        .action-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 15px 10px;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        .action-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(0, 243, 255, 0.05);
        }
        .action-icon { font-size: 1.5rem; margin-bottom: 5px; }

        .section-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin: 15px 0 10px 0;
            border-left: 2px solid var(--accent-cyan);
            padding-left: 10px;
            text-transform: uppercase;
        }

        /* --- æ—¥å¿— --- */
        .history-list { overflow-y: auto; flex: 1; padding: 10px; }
        .log-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
            display: flex;
            gap: 10px;
        }
        .log-time { color: var(--text-dim); font-size: 0.75rem; white-space: nowrap; }
        .log-content { color: #fff; line-height: 1.4; word-break: break-all; }
        .log-tag {
            font-size: 0.7rem; padding: 2px 6px; border-radius: 3px;
            background: #333; height: fit-content; white-space: nowrap;
        }
        .log-tag.ai { background: #2a2; color: #fff; }
        .log-tag.user { background: #0aa; color: #000; }

        /* --- æ–‡ä»¶ä¸Šä¼  --- */
        .upload-box {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 15px;
        }
        .upload-box:hover { border-color: var(--accent-green); color: var(--accent-green); }
        .file-input { display: none; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- è®¾ç½®å¼¹çª— --- */
        .settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .settings-box {
            background: #151515;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .settings-input {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            margin: 10px 0 20px 0;
            font-family: monospace;
        }

    </style>
</head>
<body>

<div id="settings-modal" class="settings-modal">
    <div class="settings-box">
        <h3 style="margin-top:0; color:var(--accent-cyan);">API è¿æ¥è®¾ç½®</h3>
        <p style="font-size:0.8rem; color:#888;">CORS è·¨åŸŸè­¦å‘Šï¼šè¯·ç¡®ä¿åç«¯å·²å¯ç”¨ flask-cors</p>
        <label style="font-size:0.9rem;">åç«¯åœ°å€ (ä¾‹å¦‚ http://127.0.0.1:5000)</label>
        <input type="text" id="api-url-input" class="settings-input" value="http://127.0.0.1:5000">
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" style="background:#333;" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-cyan" onclick="saveSettings()">ä¿å­˜å¹¶é‡è¿</button>
        </div>
    </div>
</div>

<header>
    <div class="brand">Unitree G1 <span style="font-size:0.5em; opacity:0.6; vertical-align: middle;">// COMMAND SYSTEM</span></div>

    <div class="header-controls">
        <div class="status-pill">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">åˆå§‹åŒ–...</span>
        </div>
        <button class="settings-btn" onclick="openSettings()" title="è®¾ç½® API åœ°å€">âš™</button>
    </div>
</header>

<div class="main-container">

    <div class="side-panel">
        <div class="card">
            <div class="card-header">Control Mode</div>
            <div class="mode-group">
                <div id="btn-auto" class="mode-btn active" onclick="requestModeChange('auto')">
                    <div>AUTO</div>
                    <div style="font-size:0.7em; opacity:0.6;">AI æ‰˜ç®¡ + éº¦å…‹é£</div>
                </div>
                <div id="btn-director" class="mode-btn" onclick="requestModeChange('director')">
                    <div>DIRECTOR</div>
                    <div style="font-size:0.7em; opacity:0.6;">ä»…äººå·¥æŒ‡ä»¤</div>
                </div>
            </div>
            <div id="mode-desc" class="mode-indicator active-auto">
                <span id="mode-icon">ğŸ¤</span>
                <span id="mode-text">æœºå™¨äººæ­£åœ¨ç›‘å¬ç¯å¢ƒå£°éŸ³...</span>
            </div>

            <div style="padding: 15px;">
                <button class="btn btn-stop" onclick="sendStop()">
                    âš  å¼ºåˆ¶æ‰“æ–­ / åœæ­¢ (STOP)
                </button>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                Interactive Logs
                <span style="cursor:pointer; font-size:1.2em;" onclick="loadHistory()">âŸ³</span>
            </div>
            <div id="log-container" class="history-list">
                </div>
        </div>
    </div>

    <div class="center-panel">
        <div class="card card-full" style="position: relative;">

            <div class="tabs">
                <div class="tab active" onclick="switchTab('tab-tts')">è¯­éŸ³å¹¿æ’­ (TTS)</div>
                <div class="tab" onclick="switchTab('tab-action')">åŠ¨ä½œå¹²é¢„ (Action)</div>
                <div class="tab" onclick="switchTab('tab-audio')">éŸ³é¢‘æ–‡ä»¶ (WAV)</div>
            </div>

            <div id="tab-tts" class="tab-content show">
                <div class="section-label">å‘é€æŒ‡å®šè¯­éŸ³ (æœ€é«˜ä¼˜å…ˆçº§)</div>
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
                    å³ä½¿åœ¨ Auto æ¨¡å¼ä¸‹ï¼Œæ­¤å¤„å‘é€çš„æ–‡å­—ä¹Ÿä¼šå¼ºåˆ¶æœºå™¨äººç«‹å³æ’­æŠ¥ã€‚
                </div>
                <textarea id="tts-input" placeholder="è¾“å…¥ä½ æƒ³è®©æœºå™¨äººè¯´çš„è¯... (ä¾‹å¦‚: æ¬¢è¿å„ä½é¢†å¯¼è…ä¸´å‚è§‚)"></textarea>
                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-cyan" onclick="sendSpeak()">âš¡ ç«‹å³å‘é€ (SPEAK)</button>
                </div>

                <div class="section-label">å¸¸ç”¨çŸ­è¯­</div>
                <div class="action-grid">
                    <div class="action-btn" onclick="fillAndSend('å¤§å®¶å¥½ï¼Œæˆ‘æ˜¯Unitree G1æœºå™¨äººã€‚')">è‡ªæˆ‘ä»‹ç»</div>
                    <div class="action-btn" onclick="fillAndSend('æˆ‘æ­£åœ¨æ€è€ƒä¸­ï¼Œè¯·ç¨ç­‰ã€‚')">æ€è€ƒä¸­</div>
                    <div class="action-btn" onclick="fillAndSend('å¥½çš„ï¼ŒåŠ¨ä½œå·²æ‰§è¡Œå®Œæ¯•ã€‚')">åŠ¨ä½œå®Œæˆ</div>
                    <div class="action-btn" onclick="fillAndSend('è¯·é—®éœ€è¦æˆ‘å±•ç¤ºä»€ä¹ˆæ‰è‰ºï¼Ÿ')">å¼•å¯¼äº’åŠ¨</div>
                </div>
            </div>

            <div id="tab-action" class="tab-content">
                <div class="section-label">æ‰‹åŠ¨è§¦å‘åŠ¨ä½œ (è¾…åŠ© AI)</div>
                <div style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
                    AI ä¼šè‡ªåŠ¨åˆ¤æ–­åŠ¨ä½œï¼Œä½†ä½ ä¹Ÿå¯ä»¥åœ¨æ­¤æ‰‹åŠ¨è§¦å‘ã€‚
                </div>
                <div class="action-grid">
                    <div class="action-btn" onclick="sendAction('loco', 'StandUp2Squat')">
                        <div class="action-icon">â¬‡</div>è¹²ä¸‹
                    </div>
                    <div class="action-btn" onclick="sendAction('loco', 'Squat2StandUp')">
                        <div class="action-icon">â¬†</div>ç«™èµ·
                    </div>
                    <div class="action-btn" onclick="sendAction('loco', 'damp')">
                        <div class="action-icon">â›”</div>é˜»å°¼/æ”¾æ¾
                    </div>
                    <div class="action-btn" onclick="sendAction('arm', 'shake hand')">
                        <div class="action-icon">ğŸ¤</div>æ¡æ‰‹
                    </div>
                    <div class="action-btn" onclick="sendAction('arm', 'high wave')">
                        <div class="action-icon">ğŸ‘‹</div>æŒ¥æ‰‹
                    </div>
                    <div class="action-btn" onclick="sendAction('arm', 'heart')">
                        <div class="action-icon">â¤ï¸</div>æ¯”å¿ƒ
                    </div>
                </div>
            </div>

            <div id="tab-audio" class="tab-content">
                <div class="section-label">ä¸Šä¼ å¹¶æ’­æ”¾ WAV æ–‡ä»¶</div>
                <label class="upload-box">
                    <div id="file-label" style="font-size: 1.2rem; font-weight: bold;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (.wav)</div>
                    <div style="font-size: 0.8rem; margin-top: 10px; color: #666;">æ”¯æŒæ ¼å¼: PCM WAV, 16k/44.1k</div>
                    <input type="file" id="wav-file" class="file-input" accept=".wav" onchange="handleFileSelect()">
                </label>
                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-cyan" style="background: var(--accent-green);" onclick="uploadAndPlay()">ä¸Šä¼ å¹¶æ’­æ”¾</button>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    let API_BASE = localStorage.getItem('G1_API_URL') || 'http://127.0.0.1:5000';
    let currentMode = 'auto'; // é»˜è®¤ä¸º auto
    let isOffline = true;

    // --- è®¾ç½®é€»è¾‘ ---
    function openSettings() {
        document.getElementById('api-url-input').value = API_BASE;
        document.getElementById('settings-modal').style.display = 'flex';
    }
    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }
    function saveSettings() {
        const newUrl = document.getElementById('api-url-input').value.replace(/\/$/, "");
        API_BASE = newUrl;
        localStorage.setItem('G1_API_URL', newUrl);
        closeSettings();
        alert("åœ°å€å·²æ›´æ–°ï¼Œæ­£åœ¨é‡è¿...");
        pingStatus();
    }

    async function safeFetch(endpoint, options = {}) {
        const url = `${API_BASE}${endpoint}`;
        // é¢„è§ˆç¯å¢ƒæ‹¦æˆª
        if (window.location.protocol === 'blob:' || window.location.host.includes('content')) {
            console.warn("Detected preview environment, blocking local request.");
            return { ok: false, status: 0, isPreview: true };
        }
        try {
            return await fetch(url, options);
        } catch (error) {
            console.error(`Fetch Error:`, error);
            return { ok: false, status: 0, error: error };
        }
    }

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        updateUIState('auto'); // é»˜è®¤æ˜¾ç¤ºä¸º Auto
        loadHistory();
        pingStatus();
        setInterval(pingStatus, 2000);
    };

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('show'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('show');

        // ç®€å•æ˜ å°„æ¿€æ´»çŠ¶æ€
        const tabs = document.querySelectorAll('.tab');
        if(tabId === 'tab-tts') tabs[0].classList.add('active');
        if(tabId === 'tab-action') tabs[1].classList.add('active');
        if(tabId === 'tab-audio') tabs[2].classList.add('active');
    }

    // --- æ¨¡å¼åˆ‡æ¢ ---
    async function requestModeChange(newMode) {
        if (newMode === currentMode && !isOffline) return;

        const btn = document.getElementById(newMode === 'auto' ? 'btn-auto' : 'btn-director');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<div>åˆ‡æ¢ä¸­...</div>`;

        const res = await safeFetch('/api/set_mode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: newMode})
        });

        btn.innerHTML = originalText;

        if (res.ok) {
            updateUIState(newMode);
        } else {
            handleError(res, "åˆ‡æ¢æ¨¡å¼å¤±è´¥");
        }
    }

    // æ›´æ–° UI çŠ¶æ€ï¼šç°åœ¨ Auto æ¨¡å¼ä¸å†é”å®šç•Œé¢
    function updateUIState(mode) {
        currentMode = mode;

        // 1. æŒ‰é’®é«˜äº®
        document.getElementById('btn-auto').className = `mode-btn ${mode === 'auto' ? 'active' : ''}`;
        document.getElementById('btn-director').className = `mode-btn ${mode === 'director' ? 'active' : ''}`;

        // 2. æ›´æ–°ä¸‹æ–¹çŠ¶æ€æ–‡å­—
        const descDiv = document.getElementById('mode-desc');
        const iconSpan = document.getElementById('mode-icon');
        const textSpan = document.getElementById('mode-text');

        if (mode === 'auto') {
            descDiv.className = "mode-indicator active-auto";
            iconSpan.innerText = "ğŸ¤";
            textSpan.innerText = "éº¦å…‹é£å·²å¼€å¯ | å…è®¸æ‰‹åŠ¨æ’æ’­æŒ‡ä»¤";
        } else {
            descDiv.className = "mode-indicator active-director";
            iconSpan.innerText = "ğŸ”‡";
            textSpan.innerText = "éº¦å…‹é£å·²å…³é—­ | ä»…å“åº”æ‰‹åŠ¨æŒ‡ä»¤";
        }

        // æ³¨æ„ï¼šè¿™é‡Œåˆ é™¤äº†é®ç½©å±‚çš„æ˜¾ç¤ºé€»è¾‘ï¼Œå®ç°äº†â€œæ‰‹åŠ¨æŒ‡ä»¤åœ¨è‡ªåŠ¨æ¨¡å¼ä¸‹å¯ç”¨â€
    }

    // --- çŠ¶æ€è½®è¯¢ ---
    async function pingStatus() {
        const res = await safeFetch('/api/status');
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');

        if (res.ok) {
            isOffline = false;
            const data = await res.json();

            if (data.is_replying) {
                dot.className = 'status-dot busy';
                text.innerText = "AI æ€è€ƒ/å›å¤ä¸­...";
                text.style.color = "var(--accent-yellow)";
            } else {
                dot.className = 'status-dot active';
                text.innerText = "ç³»ç»Ÿåœ¨çº¿";
                text.style.color = "var(--accent-green)";
            }

            if (data.mode && data.mode !== currentMode) {
                updateUIState(data.mode);
            }
        } else {
            isOffline = true;
            dot.className = 'status-dot offline';
            text.innerText = "ç¦»çº¿";
            text.style.color = "var(--accent-red)";
        }
    }

    function handleError(res, context) {
        if(!isOffline) {
            console.warn(context, res);
            alert(`${context}: è¿æ¥å¤±è´¥æˆ–è¢«æ‹’ç»`);
        }
    }

    // --- æ ¸å¿ƒåŠŸèƒ½ï¼šå‘é€æŒ‡ä»¤ ---
    // è¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨åç«¯çš„ /api/director/speak
    // å³ä½¿åœ¨ auto æ¨¡å¼ä¸‹ï¼Œåªè¦åç«¯çš„ main_loop å…ˆæ£€æŸ¥ director_queueï¼Œè¿™ä¸ªæŒ‡ä»¤å°±ä¼šè¢«ä¼˜å…ˆæ‰§è¡Œ
    async function sendSpeak() {
        const input = document.getElementById('tts-input');
        const text = input.value.trim();
        if (!text) return;

        const res = await safeFetch('/api/director/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text})
        });

        if(res.ok) {
            input.value = '';
            // ç¨ååˆ·æ–°æ—¥å¿—
            setTimeout(loadHistory, 500);
        } else {
            handleError(res, "å‘é€ TTS å¤±è´¥");
        }
    }

    function fillAndSend(text) {
        document.getElementById('tts-input').value = text;
        sendSpeak();
    }

    async function sendAction(group, name) {
        const res = await safeFetch('/api/director/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ group: group, name: name })
        });
        if (!res.ok) handleError(res, "å‘é€åŠ¨ä½œå¤±è´¥");
    }

    // --- æ–‡ä»¶å¤„ç† ---
    function handleFileSelect() {
        const input = document.getElementById('wav-file');
        if(input.files[0]) {
            document.getElementById('file-label').innerText = input.files[0].name;
            document.getElementById('file-label').style.color = 'var(--accent-green)';
        }
    }

    async function uploadAndPlay() {
        const input = document.getElementById('wav-file');
        if (!input.files[0]) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ª WAV æ–‡ä»¶");
        const formData = new FormData();
        formData.append('file', input.files[0]);
        const res = await safeFetch('/api/director/upload_play', { method: 'POST', body: formData });
        if (res.ok) {
            alert("æ’­æ”¾è¯·æ±‚å·²å‘é€");
            input.value = '';
            document.getElementById('file-label').innerText = "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (.wav)";
            document.getElementById('file-label').style.color = 'inherit';
        } else {
            handleError(res, "ä¸Šä¼ å¤±è´¥");
        }
    }

    async function sendStop() {
        await safeFetch('/api/interrupt', {method: 'POST'});
        document.body.style.transform = "translateX(5px)";
        setTimeout(() => document.body.style.transform = "none", 50);
    }

    async function loadHistory() {
        const res = await safeFetch('/api/history');
        if (res.ok) {
            const data = await res.json();
            const container = document.getElementById('log-container');
            container.innerHTML = '';

            if (data.texts && data.texts.length > 0) {
                [...data.texts].reverse().forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'log-item';

                    // ç®€å•çš„åˆ¤æ–­ï¼šå¦‚æœæ˜¯ç”¨æˆ·æ‰‹åŠ¨å‘çš„æŒ‡ä»¤ï¼Œå¯ä»¥æ ‡ä¸åŒé¢œè‰²ï¼ˆè¿™é‡Œæš‚æ—¶ç»Ÿä¸€æ ·å¼ï¼‰
                    // å®é™…é¡¹ç›®ä¸­å¯ä»¥æ ¹æ® item é‡Œçš„ source å­—æ®µåŒºåˆ† AI è¿˜æ˜¯ User
                    div.innerHTML = `
                        <div class="log-time">${item.time}</div>
                        <div class="log-content">${item.content}</div>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = '<div style="padding:20px; color:#555; text-align:center;">æš‚æ— è®°å½•</div>';
            }
        }
    }
</script>
</body>
</html>