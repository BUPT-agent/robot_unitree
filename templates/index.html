<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G1 æœºå™¨äººæŒ‡æŒ¥ä¸­å¿ƒ v2.6</title>
    <style>
        :root {
            --bg-color: #0a0b10;
            --panel-bg: rgba(20, 25, 35, 0.95);
            --border-color: #333;
            --accent-cyan: #00f3ff;
            --accent-green: #0aff00;
            --accent-red: #ff003c;
            --accent-yellow: #ffcc00;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --font-tech: 'Segoe UI', 'Microsoft YaHei', 'Roboto Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            background-image:
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
            color: var(--text-main);
            font-family: var(--font-tech);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  --- */
        header {
            height: 60px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            background: rgba(0,0,0,0.95);
            z-index: 100;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: 2px;
            color: var(--accent-cyan);
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .status-pill {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            background: #111;
            padding: 6px 16px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            min-width: 140px;
            justify-content: center;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #444;
            border-radius: 50%;
            margin-right: 10px;
            box-shadow: 0 0 5px #444;
            transition: all 0.3s;
        }
        .status-dot.active { background: var(--accent-green); box-shadow: 0 0 8px var(--accent-green); }
        .status-dot.busy { background: var(--accent-yellow); box-shadow: 0 0 8px var(--accent-yellow); }
        .status-dot.offline { background: var(--accent-red); box-shadow: 0 0 8px var(--accent-red); }

        .settings-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-dim);
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1.2rem;
        }
        .settings-btn:hover { color: #fff; border-color: #fff; }

        /* --- ä¸»å¸ƒå±€ --- */
        .main-container {
            display: flex;
            flex: 1;
            padding: 20px;
            gap: 20px;
            overflow: hidden;
            position: relative;
        }

        .side-panel { width: 300px; display: flex; flex-direction: column; gap: 20px; }
        .center-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; min-width: 400px; }

        /* --- å¡ç‰‡é€šç”¨ --- */
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            position: relative;
        }
        .card-full { flex: 1; }

        .card-header {
            padding: 12px 15px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border-color);
            background: rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* --- æ¨¡å¼åˆ‡æ¢ --- */
        .mode-group {
            display: flex;
            background: #000;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .mode-btn {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--text-dim);
            border-bottom: 2px solid transparent;
        }
        .mode-btn:hover { background: #1a1a1a; color: #fff; }
        .mode-btn.active {
            background: rgba(0, 243, 255, 0.15);
            color: var(--accent-cyan);
            border-bottom: 2px solid var(--accent-cyan);
        }
        .mode-btn.loading {
            cursor: wait;
            opacity: 0.7;
            animation: pulse 1s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* --- å†…å®¹åŒºåŸŸ --- */
        .tabs { display: flex; border-bottom: 1px solid var(--border-color); }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            color: var(--text-dim);
            font-weight: bold;
            font-size: 0.9rem;
            transition: 0.2s;
            border-right: 1px solid var(--border-color);
        }
        .tab:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .tab.active {
            color: var(--accent-cyan);
            background: rgba(0, 243, 255, 0.05);
            border-bottom: 2px solid var(--accent-cyan);
        }

        .tab-content { padding: 20px; display: none; flex: 1; overflow-y: auto; flex-direction: column; }
        .tab-content.show { display: flex; }

        /* --- æ§ä»¶ --- */
        textarea {
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            color: #fff;
            padding: 15px;
            border-radius: 4px;
            height: 120px;
            font-family: var(--font-tech);
            font-size: 1rem;
            resize: none;
            width: 100%;
            margin-bottom: 15px;
        }
        textarea:focus { outline: 1px solid var(--accent-cyan); border-color: var(--accent-cyan); }

        .btn {
            border: none;
            padding: 12px 24px;
            cursor: pointer;
            font-weight: bold;
            font-family: var(--font-tech);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 2px;
            transition: 0.2s;
            font-size: 0.9rem;
        }
        .btn-cyan { background: var(--accent-cyan); color: #000; }
        .btn-cyan:hover { background: #fff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.5); }

        .btn-stop {
            background: rgba(255, 0, 60, 0.1);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
            width: 100%;
            margin-top: 10px;
            padding: 15px;
            font-size: 1rem;
        }
        .btn-stop:hover { background: var(--accent-red); color: #fff; box-shadow: 0 0 20px rgba(255, 0, 60, 0.4); }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
        }
        .action-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-color);
            color: var(--text-main);
            padding: 15px 10px;
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            position: relative;
        }
        .action-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(0, 243, 255, 0.05);
        }
        /* ç¼–è¾‘æ¨¡å¼ä¸‹çš„æ ·å¼è°ƒæ•´ */
        .action-btn.editable {
            border-style: dashed;
        }
        .action-btn.editing-active {
            border-color: var(--accent-green);
            background: rgba(10, 255, 0, 0.1);
            box-shadow: 0 0 10px rgba(10, 255, 0, 0.2);
        }
        .delete-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 20px;
            height: 20px;
            background: var(--accent-red);
            color: white;
            border-radius: 50%;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .action-icon { font-size: 1.5rem; margin-bottom: 5px; }

        .section-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin: 20px 0 10px 0;
            border-left: 2px solid var(--accent-cyan);
            padding-left: 10px;
            text-transform: uppercase;
        }
        .section-label:first-child { margin-top: 0; }

        /* --- ä¸Šä¼ æ§ä»¶æ ·å¼ --- */
        .upload-box {
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            margin-bottom: 15px;
            background: rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .upload-box:hover { border-color: var(--accent-green); color: var(--accent-green); background: rgba(10, 255, 0, 0.05); }
        .file-input { display: none; }

        /* --- æ—¥å¿— --- */
        .history-list { overflow-y: auto; flex: 1; padding: 10px; }
        .log-item {
            padding: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.9rem;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .log-time { color: var(--text-dim); font-size: 0.75rem; margin-bottom: 3px; display: inline-block; width: 60px;}
        .log-content { color: #fff; display: inline-block; }
        .log-type-cmd { color: var(--accent-cyan); }
        .log-type-err { color: var(--accent-red); }

        /* --- é®ç½©å±‚ --- */
        .disabled-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(10, 11, 16, 0.85);
            z-index: 50;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            font-size: 1.2rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-align: center;
            gap: 15px;
            border-radius: 6px;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* --- è®¾ç½®å¼¹çª— --- */
        .settings-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 999;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .settings-box {
            background: #151515;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            width: 400px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }
        .settings-input {
            width: 100%;
            padding: 10px;
            background: #000;
            border: 1px solid #333;
            color: #fff;
            margin: 10px 0 20px 0;
            font-family: monospace;
        }

    </style>
</head>
<body>

<!-- è®¾ç½®å¼¹çª— -->
<div id="settings-modal" class="settings-modal">
    <div class="settings-box">
        <h3 style="margin-top:0; color:var(--accent-cyan);">API è¿æ¥è®¾ç½®</h3>
        <p style="font-size:0.8rem; color:#888;">ç”±äºæµè§ˆå™¨çš„å®‰å…¨é™åˆ¶(CORS)ï¼Œæœ¬åœ° HTML æ–‡ä»¶å¯èƒ½æ— æ³•ç›´æ¥è¿æ¥åç«¯ã€‚è¯·ç¡®è®¤åç«¯åœ°å€ã€‚</p>
        <label style="font-size:0.9rem;">åç«¯åœ°å€ (ä¾‹å¦‚ http://127.0.0.1:5000)</label>
        <input type="text" id="api-url-input" class="settings-input" value="http://127.0.0.1:5000">
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button class="btn" style="background:#333;" onclick="closeSettings()">å–æ¶ˆ</button>
            <button class="btn btn-cyan" onclick="saveSettings()">ä¿å­˜å¹¶é‡è¿</button>
        </div>
    </div>
</div>

<header>
    <div class="brand">Unitree G1 <span style="font-size:0.5em; opacity:0.6; vertical-align: middle;">// COMMAND V2.6</span></div>

    <div class="header-controls">
        <div class="status-pill">
            <div id="status-dot" class="status-dot"></div>
            <span id="status-text">åˆå§‹åŒ–...</span>
        </div>
        <button class="settings-btn" onclick="openSettings()" title="è®¾ç½® API åœ°å€">âš™</button>
    </div>
</header>

<div class="main-container">

    <!-- å·¦ä¾§ï¼šæ¨¡å¼ä¸ç´§æ€¥æ§åˆ¶ -->
    <div class="side-panel">
        <div class="card">
            <div class="card-header">Control Mode</div>
            <div class="mode-group">
                <div id="btn-auto" class="mode-btn active" onclick="requestModeChange('auto')">
                    <div>AUTO</div>
                    <div style="font-size:0.7em; opacity:0.6;">AI è¯­éŸ³æ‰˜ç®¡</div>
                </div>
                <div id="btn-director" class="mode-btn" onclick="requestModeChange('director')">
                    <div>DIRECTOR</div>
                    <div style="font-size:0.7em; opacity:0.6;">äººå·¥æŒ‡ä»¤</div>
                </div>
            </div>
            <div style="padding: 15px;">
                <button class="btn btn-stop" onclick="sendStop()">
                    âš  ç´§æ€¥åœæ­¢ (STOP)
                </button>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                Operation Logs
                <div style="font-size:0.7em; text-transform:none;">(Local)</div>
            </div>
            <div id="log-container" class="history-list">
                <!-- Local Logs go here -->
                <div style="padding:10px; color:#555; text-align:center;">æš‚æ— æ“ä½œè®°å½•</div>
            </div>
        </div>
    </div>

    <!-- ä¸­é—´ï¼šåŠŸèƒ½æ§åˆ¶åŒº -->
    <div class="center-panel">
        <div class="card card-full" style="position: relative;">

            <!-- è‡ªåŠ¨æ¨¡å¼ä¸‹çš„é®ç½© -->
            <div id="director-overlay" class="disabled-overlay">
                <div style="font-size: 3rem; margin-bottom: 10px;">ğŸ”’</div>
                <div>ç³»ç»Ÿå¤„äºè‡ªåŠ¨æ‰˜ç®¡æ¨¡å¼ (AI)</div>
                <div style="font-size:0.7em; opacity:0.7;">è¯·åœ¨å·¦ä¾§åˆ‡æ¢è‡³ "DIRECTOR" æ¨¡å¼ä»¥æ“ä½œ</div>
            </div>

            <div class="tabs">
                <div class="tab active" onclick="switchTab('tab-tts')">è¯­éŸ³å¹¿æ’­ (TTS)</div>
                <div class="tab" onclick="switchTab('tab-action')">åŠ¨ä½œæ§åˆ¶ (Action)</div>
                <div class="tab" onclick="switchTab('tab-audio')">éŸ³é¢‘æ’­æ”¾ (WAV)</div>
            </div>

            <!-- Tab 1: TTS -->
            <div id="tab-tts" class="tab-content show">
                <div class="section-label">å‘é€è¯­éŸ³æŒ‡ä»¤</div>
                <textarea id="tts-input" placeholder="åœ¨æ­¤è¾“å…¥æ–‡å­—ï¼Œæœºå™¨äººå°†é€šè¿‡ TTS æ’­æŠ¥..."></textarea>
                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-cyan" onclick="sendSpeak()">å‘é€è¯­éŸ³ (SPEAK)</button>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin: 20px 0 10px 0;">
                    <div class="section-label" style="margin:0;">å¿«æ·çŸ­è¯­</div>
                    <button class="settings-btn" onclick="toggleEditMode()" title="ç®¡ç†çŸ­è¯­" style="font-size:1rem; border:none;">âš™ï¸ ç®¡ç†</button>
                </div>

                <!-- ç¼–è¾‘åŒºåŸŸ (é»˜è®¤éšè—) -->
                <div id="edit-controls" style="display:none; background:rgba(255,255,255,0.03); padding:15px; border-radius:4px; margin-bottom:15px; border:1px dashed var(--border-color);">
                    <div style="font-size:0.8rem; color:#888; margin-bottom:10px;" id="edit-title">æ·»åŠ æ–°çŸ­è¯­:</div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input id="new-phrase-label" placeholder="æŒ‰é’®æ ‡ç­¾ (å¦‚: 6.å†è§)" style="flex:1; background:#000; border:1px solid #333; color:#fff; padding:8px; font-family:inherit;">
                        <input id="new-phrase-text" placeholder="å®Œæ•´è¯­éŸ³å†…å®¹..." style="flex:2; background:#000; border:1px solid #333; color:#fff; padding:8px; font-family:inherit;">
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button id="save-phrase-btn" class="btn btn-cyan" style="flex:1; padding:8px; font-size:0.8rem;" onclick="handleSavePhrase()">+ ç¡®è®¤æ·»åŠ </button>
                        <button id="cancel-edit-btn" class="btn" style="display:none; flex:0 0 80px; background:#333; padding:8px; font-size:0.8rem;" onclick="resetEditState()">å–æ¶ˆ</button>
                    </div>
                    <div style="font-size:0.75rem; color:var(--accent-red); margin-top:10px; text-align:center;">
                        æç¤º: ç‚¹å‡»ä¸‹æ–¹çŸ­è¯­å¯ã€ç¼–è¾‘å†…å®¹ã€‘ï¼Œç‚¹å‡»çº¢è‰²è§’æ ‡å¯ã€åˆ é™¤ã€‘
                    </div>
                </div>

                <div id="quick-phrases-list" class="action-grid">
                    <!-- Javascript generated content -->
                </div>
            </div>

            <!-- Tab 2: Actions (Updated based on config.py) -->
            <div id="tab-action" class="tab-content">
                <div class="section-label">åŸºç¡€å§¿æ€ (Locomotion)</div>
                <div class="action-grid">
                    <div class="action-btn" onclick="sendAction('loco', 'StandUp2Squat')">
                        <div class="action-icon">â¬‡</div>è¹²ä¸‹
                    </div>
                    <div class="action-btn" onclick="sendAction('loco', 'Squat2StandUp')">
                        <div class="action-icon">â¬†</div>ç«™èµ·
                    </div>
                     <div class="action-btn" onclick="sendAction('loco', 'low stand')">
                        <div class="action-icon">ğŸ“</div>ä½ç«™å§¿
                    </div>
                    <div class="action-btn" onclick="sendAction('loco', 'high stand')">
                        <div class="action-icon">ğŸ“</div>é«˜ç«™å§¿
                    </div>
                     <div class="action-btn" onclick="sendAction('loco', 'damp')">
                        <div class="action-icon">â›”</div>é˜»å°¼(è½¯)
                    </div>
                </div>

                <div class="section-label">ç§»åŠ¨æµ‹è¯• (æ…ç”¨)</div>
                <div class="action-grid">
                    <div class="action-btn" onclick="sendAction('loco', 'move forward')">å‘å‰ä¸€æ­¥</div>
                    <div class="action-btn" onclick="sendAction('loco', 'move lateral')">å·¦å³æ¨ªç§»</div>
                    <div class="action-btn" onclick="sendAction('loco', 'move rotate')">åŸåœ°æ—‹è½¬</div>
                </div>

                <div class="section-label">ç¤¾äº¤åŠ¨ä½œ (Arm)</div>
                <div class="action-grid">
                    <div class="action-btn" onclick="sendAction('arm', 'shake hand')">ğŸ¤ æ¡æ‰‹</div>
                    <div class="action-btn" onclick="sendAction('arm', 'high wave')">ğŸ‘‹ æŒ¥æ‰‹</div>
                    <div class="action-btn" onclick="sendAction('arm', 'heart')">â¤ï¸ æ¯”å¿ƒ</div>
                    <div class="action-btn" onclick="sendAction('arm', 'high five')">âœ‹ å‡»æŒ</div>
                    <div class="action-btn" onclick="sendAction('arm', 'clap')">ğŸ‘ é¼“æŒ</div>
                    <div class="action-btn" onclick="sendAction('arm', 'hug')">ğŸ¤— æ‹¥æŠ±</div>
                    <div class="action-btn" onclick="sendAction('arm', 'hands up')">ğŸ™Œ ä¸¾æ‰‹</div>
                    <div class="action-btn" onclick="sendAction('arm', 'release arm')">ğŸ”“ æ”¾æ¾æ‰‹è‡‚</div>
                </div>
                 <div class="section-label">å…¶ä»–</div>
                 <div class="action-grid">
                     <div class="action-btn" onclick="sendAction('loco', 'wave hand1')">æ‘†æ‰‹ 1</div>
                     <div class="action-btn" onclick="sendAction('loco', 'wave hand2')">æ‘†æ‰‹ 2</div>
                 </div>
            </div>

             <!-- Tab 3: Audio (æ–°å¢) -->
            <div id="tab-audio" class="tab-content">
                <div class="section-label">ä¸Šä¼ å¹¶æ’­æ”¾ WAV æ–‡ä»¶</div>
                <label class="upload-box">
                    <div style="font-size: 3rem; color: var(--text-dim);">â™«</div>
                    <div id="file-label" style="font-size: 1.1rem; font-weight: bold;">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (.wav)</div>
                    <div style="font-size: 0.8rem; margin-top: 5px; color: #666;">æ”¯æŒæ ¼å¼: PCM WAV, 16k/44.1k</div>
                    <input type="file" id="wav-file" class="file-input" accept=".wav" onchange="handleFileSelect()">
                </label>
                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-cyan" style="background: var(--accent-green);" onclick="uploadAndPlay()">ä¸Šä¼ å¹¶è‡ªåŠ¨æ’­æ”¾</button>
                </div>
                <div class="section-label" style="margin-top: 30px;">è¯´æ˜</div>
                <div style="color: #666; font-size: 0.85rem; line-height: 1.5;">
                    æ–‡ä»¶å°†ä¸Šä¼ è‡³è¿è¡Œæœºå™¨äººçš„ç”µè„‘å¹¶ç›´æ¥æ’­æ”¾ã€‚<br>
                    è¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼ä¸ºæ ‡å‡†çš„ WAV æ ¼å¼ï¼Œå¦åˆ™æœºå™¨äººå¯èƒ½æ— æ³•å‘å£°ã€‚
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    let API_BASE = localStorage.getItem('G1_API_URL') || 'http://127.0.0.1:5000';
    let currentMode = 'auto';
    let isOffline = true;

    // --- çŸ­è¯­ç®¡ç†é€»è¾‘ ---
    // é»˜è®¤çŸ­è¯­æ•°æ® (v2)
    const DEFAULT_PHRASES = [
        { label: "æ¬¢è¿è¯", text: "æˆ‘æ˜¯æ¡‚å°å¿—ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜éƒ½å¯ä»¥é—®æˆ‘" },
        { label: "1ã€æƒ³å»ä¸œå—äºš", text: "æ™“æ—­å§å§ï¼Œæˆ‘ä¹Ÿæƒ³å»ä¸œå—äºšï¼Œæˆ‘ä¹Ÿæƒ³å»åšå¿—æ„¿è€…ï¼Œæˆ‘å¬è¯´å»ä¸œå—äºšå¯å¥½ç©å„¿äº†ã€‚" },
        { label: "2ã€è¿çº¿é™†å®‡", text: "å¤ªå¥½äº†ï¼Œå¬è¯´å‰æ®µæ—¶é—´ï¼Œæˆ‘ä»¬çš„å¿—æ„¿è€…é™†å®‡å°å§å§å·²ç»åˆ°äº†æŸ¬åŸ”å¯¨ï¼Œè¦ä¸è¦æˆ‘ä»¬ç°åœ¨ä¸å¥¹æ‰“ä¸ªè§†é¢‘ç”µè¯ã€‚" },
        { label: "3ã€ç¥é¡ºåˆ©", text: "8 8ï¼Œé™†å®‡å°å§å§ï¼Œå¸Œæœ›ä½ ä»¬åœ¨æŸ¬åŸ”å¯¨ä¸€åˆ‡é¡ºåˆ©ã€‚" },
        { label: "4ã€åŠ å…¥æ¡‚å¿—æ„¿", text: "æˆ‘ä»¬éƒ½æ˜¯å¿—æ„¿è€…ï¼Œè¯·åŠ å…¥â€œæ¡‚å¿—æ„¿â€ï¼Œä¸æˆ‘ä»¬å…±åŒæ”¶è·å‘ä¸Šå‘å–„çš„åŠ›é‡ã€‚" },
        { label: "5ã€ç¥å¿—æ„¿è€…", text: "æœ€åï¼Œç¥æ‰€æœ‰çš„å¿—æ„¿è€…æœ‹å‹ä»¬ï¼š" }
    ];

    let quickPhrases = [];
    let isEditMode = false;
    let editingIndex = -1; // -1 è¡¨ç¤ºæ·»åŠ æ¨¡å¼ï¼Œå…¶ä»–å€¼è¡¨ç¤ºæ­£åœ¨ç¼–è¾‘è¯¥ç´¢å¼•

    // --- è®¾ç½®é€»è¾‘ ---
    function openSettings() {
        document.getElementById('api-url-input').value = API_BASE;
        document.getElementById('settings-modal').style.display = 'flex';
    }
    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }
    function saveSettings() {
        const newUrl = document.getElementById('api-url-input').value.replace(/\/$/, "");
        API_BASE = newUrl;
        localStorage.setItem('G1_API_URL', newUrl);
        closeSettings();
        pingStatus();
    }

    // --- ç½‘ç»œè¯·æ±‚å°è£… (å·²ä¿®å¤) ---
    async function safeFetch(endpoint, options = {}, suppressError = false) {
        const url = `${API_BASE}${endpoint}`;
        try {
            const res = await fetch(url, options);
            return res;
        } catch (error) {
            if (!suppressError) {
                console.error(`Fetch Error [${url}]:`, error);
            }
            return { ok: false, status: 0, error: error };
        }
    }

    // --- åˆå§‹åŒ– ---
    window.onload = function() {
        updateUIState('auto');
        initPhrases(); // åˆå§‹åŒ–çŸ­è¯­
        pingStatus();
        setInterval(pingStatus, 2000); // 2ç§’å¿ƒè·³
    };

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('show'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('show');

        const tabs = document.querySelectorAll('.tab');
        tabs[0].classList.toggle('active', tabId === 'tab-tts');
        tabs[1].classList.toggle('active', tabId === 'tab-action');
        tabs[2].classList.toggle('active', tabId === 'tab-audio');
    }

    // --- æ¨¡å¼åˆ‡æ¢ ---
    async function requestModeChange(newMode) {
        if (newMode === currentMode && !isOffline) return;

        const btn = document.getElementById(newMode === 'auto' ? 'btn-auto' : 'btn-director');
        const originalText = btn.innerHTML;
        btn.innerHTML = `<div>åˆ‡æ¢ä¸­...</div>`;
        btn.classList.add('loading');

        const res = await safeFetch('/api/set_mode', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({mode: newMode})
        });

        btn.classList.remove('loading');
        btn.innerHTML = originalText;

        if (res.ok) {
            updateUIState(newMode);
            addLog(`åˆ‡æ¢æ¨¡å¼: ${newMode.toUpperCase()}`, 'cmd');
        } else {
            handleError(res, "åˆ‡æ¢æ¨¡å¼å¤±è´¥");
        }
    }

    function updateUIState(mode) {
        currentMode = mode;
        document.getElementById('btn-auto').className = `mode-btn ${mode === 'auto' ? 'active' : ''}`;
        document.getElementById('btn-director').className = `mode-btn ${mode === 'director' ? 'active' : ''}`;
        const overlay = document.getElementById('director-overlay');
        overlay.style.display = (mode === 'auto') ? 'flex' : 'none';
    }

    // --- å¿ƒè·³æ£€æµ‹ ---
    async function pingStatus() {
        const res = await safeFetch('/api/status', {}, true);
        const dot = document.getElementById('status-dot');
        const text = document.getElementById('status-text');

        if (res.ok) {
            isOffline = false;
            const data = await res.json();

            if (data.is_replying) {
                dot.className = 'status-dot busy';
                text.innerText = "æœºå™¨äººå¿™ç¢Œä¸­...";
                text.style.color = "var(--accent-yellow)";
            } else {
                dot.className = 'status-dot active';
                text.innerText = "ç³»ç»Ÿåœ¨çº¿";
                text.style.color = "var(--accent-green)";
            }

            if (data.mode && data.mode !== currentMode) {
                updateUIState(data.mode);
            }
        } else {
            isOffline = true;
            dot.className = 'status-dot offline';
            text.innerText = "ç¦»çº¿";
            text.style.color = "var(--accent-red)";
        }
    }

    // --- é”™è¯¯å¤„ç† ---
    function handleError(res, context) {
        let msg = `${context} (Error: ${res.status || 'Connect Failed'})`;
        console.warn(msg);
        addLog(msg, 'err');
    }

    // --- æŒ‡ä»¤å‘é€ ---
    async function sendSpeak() {
        const input = document.getElementById('tts-input');
        const text = input.value.trim();
        if (!text) return;

        const res = await safeFetch('/api/director/speak', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({text})
        });

        if(res.ok) {
            const displayText = text.length > 15 ? text.substring(0, 15) + "..." : text;
            addLog(`å‘é€è¯­éŸ³: "${displayText}"`, 'cmd');
            input.value = '';
        } else {
            handleError(res, "å‘é€ TTS å¤±è´¥");
        }
    }

    function fillAndSend(text) {
        if(isEditMode) return; // ç¼–è¾‘æ¨¡å¼ä¸‹ç¦æ­¢ç‚¹å‡»å‘é€
        document.getElementById('tts-input').value = text;
        sendSpeak();
    }

    async function sendAction(group, name) {
        addLog(`å‘é€åŠ¨ä½œ: ${name} (${group})`, 'cmd');
        const res = await safeFetch('/api/director/action', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ group: group, name: name })
        });

        if (!res.ok) handleError(res, "å‘é€åŠ¨ä½œå¤±è´¥");
    }

    async function sendStop() {
        addLog("âš  å‘é€ç´§æ€¥åœæ­¢æŒ‡ä»¤", 'err');
        await safeFetch('/api/interrupt', {method: 'POST'});
        document.body.style.transform = "translateX(5px)";
        setTimeout(() => document.body.style.transform = "none", 50);
    }

    // --- æ–‡ä»¶ä¸Šä¼ é€»è¾‘ ---
    function handleFileSelect() {
        const input = document.getElementById('wav-file');
        if(input.files[0]) {
            document.getElementById('file-label').innerText = input.files[0].name;
            document.getElementById('file-label').style.color = 'var(--accent-green)';
        }
    }

    async function uploadAndPlay() {
        const input = document.getElementById('wav-file');
        if (!input.files[0]) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ª WAV æ–‡ä»¶");
        addLog(`æ­£åœ¨ä¸Šä¼ : ${input.files[0].name}...`, 'cmd');
        const formData = new FormData();
        formData.append('file', input.files[0]);
        const res = await safeFetch('/api/director/upload_play', { method: 'POST', body: formData });
        if (res.ok) {
            addLog(`ä¸Šä¼ æˆåŠŸï¼Œæ­£åœ¨æ’­æ”¾éŸ³é¢‘`, 'cmd');
            input.value = '';
            document.getElementById('file-label').innerText = "ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (.wav)";
            document.getElementById('file-label').style.color = 'inherit';
        } else {
            handleError(res, "ä¸Šä¼ å¤±è´¥");
        }
    }

    // --- åŠ¨æ€çŸ­è¯­ç®¡ç†åŠŸèƒ½ ---
    function initPhrases() {
        const stored = localStorage.getItem('g1_quick_phrases_v2');
        if (stored) {
            try {
                quickPhrases = JSON.parse(stored);
            } catch(e) {
                quickPhrases = DEFAULT_PHRASES;
            }
        } else {
            quickPhrases = [...DEFAULT_PHRASES];
        }
        renderPhrases();
    }

    function savePhrases() {
        localStorage.setItem('g1_quick_phrases_v2', JSON.stringify(quickPhrases));
        renderPhrases();
    }

    function toggleEditMode() {
        isEditMode = !isEditMode;
        document.getElementById('edit-controls').style.display = isEditMode ? 'block' : 'none';
        resetEditState(); // æ¯æ¬¡å¼€å…³éƒ½é‡ç½®çŠ¶æ€
        renderPhrases();
    }

    function resetEditState() {
        editingIndex = -1;
        document.getElementById('new-phrase-label').value = '';
        document.getElementById('new-phrase-text').value = '';
        document.getElementById('save-phrase-btn').innerText = "+ ç¡®è®¤æ·»åŠ ";
        document.getElementById('save-phrase-btn').className = "btn btn-cyan";
        document.getElementById('cancel-edit-btn').style.display = 'none';
        document.getElementById('edit-title').innerText = "æ·»åŠ æ–°çŸ­è¯­:";
        renderPhrases(); // åˆ·æ–°ä»¥ç§»é™¤é€‰ä¸­é«˜äº®
    }

    function startEditing(index) {
        editingIndex = index;
        const p = quickPhrases[index];
        document.getElementById('new-phrase-label').value = p.label;
        document.getElementById('new-phrase-text').value = p.text;

        // æ›´æ–°ç•Œé¢çŠ¶æ€
        document.getElementById('save-phrase-btn').innerText = "ğŸ’¾ ä¿å­˜ä¿®æ”¹";
        document.getElementById('save-phrase-btn').className = "btn btn-cyan";
        document.getElementById('cancel-edit-btn').style.display = 'block';
        document.getElementById('edit-title').innerText = `æ­£åœ¨ç¼–è¾‘: ${p.label}`;

        renderPhrases(); // åˆ·æ–°é«˜äº®
    }

    function handleSavePhrase() {
        const labelInput = document.getElementById('new-phrase-label');
        const textInput = document.getElementById('new-phrase-text');
        const label = labelInput.value.trim();
        const text = textInput.value.trim();

        if (!label || !text) {
            alert("è¯·å¡«å†™æ ‡ç­¾å’Œå®Œæ•´å†…å®¹");
            return;
        }

        if (editingIndex > -1) {
            // ä¿®æ”¹ç°æœ‰
            quickPhrases[editingIndex] = { label, text };
            addLog(`ä¿®æ”¹çŸ­è¯­: ${label}`, 'cmd');
        } else {
            // æ·»åŠ æ–°
            quickPhrases.push({ label, text });
            addLog(`æ·»åŠ çŸ­è¯­: ${label}`, 'cmd');
        }

        savePhrases();
        resetEditState();
    }

    function deletePhrase(index) {
        if (!confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªçŸ­è¯­å—ï¼Ÿ")) return;

        // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰æ­£åœ¨ç¼–è¾‘çš„ï¼Œé‡ç½®ç¼–è¾‘çŠ¶æ€
        if (index === editingIndex) {
            resetEditState();
        } else if (index < editingIndex) {
            editingIndex--; // ç´¢å¼•ç§»ä½ä¿®æ­£
        }

        quickPhrases.splice(index, 1);
        savePhrases();
        addLog(`åˆ é™¤çŸ­è¯­ (Index: ${index})`, 'cmd');
    }

    function renderPhrases() {
        const container = document.getElementById('quick-phrases-list');
        container.innerHTML = '';

        quickPhrases.forEach((p, index) => {
            const div = document.createElement('div');
            // æ·»åŠ åŸºç¡€ç±»
            let cssClass = 'action-btn';
            if (isEditMode) cssClass += ' editable';
            if (index === editingIndex) cssClass += ' editing-active';
            div.className = cssClass;

            // ç‚¹å‡»äº‹ä»¶é€»è¾‘
            if (!isEditMode) {
                // æ­£å¸¸æ¨¡å¼ï¼šç‚¹å‡»å‘é€
                div.onclick = () => fillAndSend(p.text);
            } else {
                // ç¼–è¾‘æ¨¡å¼ï¼šç‚¹å‡»è¿›å…¥ç¼–è¾‘
                div.onclick = () => startEditing(index);
            }

            // æ„é€  HTML
            let html = `<div>${p.label}</div>`;
            if (isEditMode) {
                html += `<div class="delete-badge" onclick="event.stopPropagation(); deletePhrase(${index})">Ã—</div>`;
            }

            div.innerHTML = html;
            container.appendChild(div);
        });
    }

    // --- æœ¬åœ°æ—¥å¿—ç³»ç»Ÿ ---
    function addLog(message, type = 'norm') {
        const container = document.getElementById('log-container');
        if (container.children.length === 1 && container.children[0].innerText === "æš‚æ— æ“ä½œè®°å½•") {
            container.innerHTML = '';
        }

        const div = document.createElement('div');
        div.className = 'log-item';

        const timeStr = new Date().toLocaleTimeString('zh-CN', {hour12: false});
        const typeClass = type === 'cmd' ? 'log-type-cmd' : (type === 'err' ? 'log-type-err' : '');

        div.innerHTML = `
            <span class="log-time">[${timeStr}]</span>
            <span class="log-content ${typeClass}">${message}</span>
        `;

        container.insertBefore(div, container.firstChild);
    }
</script>
</body>
</html>